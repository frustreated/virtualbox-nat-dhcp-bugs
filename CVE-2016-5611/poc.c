/* 
 * DHCP code based on project by Samuel Jacob (samueldotj@gmail.com)
 * https://github.com/samueldotj/dhcp-client
 */

#include <err.h>
#include "dhcp-client.h"

#define NB_ADDR		16

pcap_t *pcap_handle;
char *dev;

int
fill_dhcp_decline_options(dhcp_t *dhcp)
{
	int len = 0;
	u_int8_t option;

	/* DHCP decline */
	option = DHCP_OPTION_PACK;
	len += fill_dhcp_option(&dhcp->bp_options[len], MESSAGE_TYPE_DHCP, &option, sizeof(option));
	memset(&dhcp->bp_options[len], MESSAGE_TYPE_PAD, DHCP_OPT_LEN - len);	// No MESSAGE_TYPE_END
	return DHCP_OPT_LEN;
}

int
dhcp_decline(u_int8_t *mac)
{
	int len = 0;
	u_char packet[4096];
	struct udphdr *udp_header;
	struct ip *ip_header;
	dhcp_t *dhcp;

	ip_header = (struct ip *)(packet + sizeof(struct ether_header));
	udp_header = (struct udphdr *)(((char *)ip_header) + sizeof(struct ip));
	dhcp = (dhcp_t *)(((char *)udp_header) + sizeof(struct udphdr));

	len = fill_dhcp_decline_options(dhcp);
	dhcp_output(dhcp, mac, &len);
	udp_output(udp_header, &len);
	ip_output(ip_header, &len);
	ether_output(packet, mac, len);

	return 0;
}

int main(int argc, char **argv)
{
	int rv;
	char errbuf[PCAP_ERRBUF_SIZE];
	u_int8_t mac[6];

	if (argc < 2)
		errx(EXIT_FAILURE, "[!] Usage: %s <interface>", argv[0]);
	dev = argv[1];

	rv = get_mac_address(dev, mac);
	if (rv != 0)
		errx(EXIT_FAILURE, "[!] Unable to get MAC address for %s", dev);

	pcap_handle = pcap_open_live(dev, BUFSIZ, 0, 10, errbuf);
	if (pcap_handle == NULL)
		errx(EXIT_FAILURE, "[!] Couldn't open device %s", errbuf);

	dhcp_decline(mac);

	pcap_close(pcap_handle);

	return 0;
}

